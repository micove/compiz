#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

CORE_ABIVERSION := $(shell sed -rn 's/^\#define[[:space:]]+CORE_ABIVERSION[[:space:]]+//p' include/core/abiversion.h )

# http://bazaar.launchpad.net/~compiz-team/compiz-core/0.9.7/revision/3075
# TODO: Pass the default plugin list to each of the backends (ini, gconf, etc).
# DEFAULT_PLUGINS = "ccp"
DEFAULT_PLUGINS = "core composite opengl decor mousepoll snap compiztoolbox resize gnomecompat wall grid regex vpswitch place move session animation expo workarounds ezoom staticswitcher fade scale"

override_dh_auto_configure:
	# currently, segfault if CMAKE_BUILD_TYPE=Release
	dh_auto_configure -- \
			-DCOMPIZ_BUILD_WITH_RPATH=FALSE \
			-DCOMPIZ_DEFAULT_PLUGINS=\"$(DEFAULT_PLUGINS)\" \
			-DCMAKE_BUILD_TYPE=RelWithDebInfo \
			-DCOMPIZ_PACKAGING_ENABLED=TRUE \
			-Dlibdir=/usr/lib/$(DEB_HOST_MULTIARCH) \
			-DUSE_GSETTINGS=OFF \
			-DUSE_GCONF=ON \
			-DCOMPIZ_DISABLE_PLUGIN_INOTIFY=ON \
			-DCOMPIZ_DISABLE_PLUGIN_DBUS=ON

override_dh_clean:
	dh_clean .AUTHORS.sed po/compiz.pot

override_dh_gencontrol:
	dh_gencontrol -- -Vcoreabiversion=$(CORE_ABIVERSION)

override_dh_install:
	# cmake findcompiz_install use COMPIZ_DESTDIR and using COMPIZ_DESTDIR and
	# DESTDIR together is completely broken upstream
	# So, doing the same in debian/rules to find a way to install things in the
	# right place, sorry for the kittens
	cmake_dir=`cmake --system-information 2> /dev/null | grep "^CMAKE_ROOT " | sed -e 's/.*"\(.*\)"/\1/'` && \
	mkdir -p debian/tmp$${cmake_dir}/Modules && cp cmake/FindCompiz.cmake debian/tmp$${cmake_dir}/Modules

	dh_install --fail-missing

%:
	dh $@
